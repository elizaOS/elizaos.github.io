name: Deploy to GitHub Pages

on:
  push:
    branches: ["main"]
    paths:
      - "src/**"
      - ".github/workflows/deploy.yml"
      - "package.json"
  workflow_dispatch:
  workflow_run:
    workflows: ["Run Pipelines"]
    branches: [main]
    types: [completed]

permissions:
  contents: write
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

env:
  DATA_DIR: "data"
  PIPELINE_DATA_BRANCH: "_data"

  # =============================================================================
  # FORK-SPECIFIC CONFIG - Edit these values for your fork
  # =============================================================================
  PIPELINE_START_DATE: "2024-10-15"
  PIPELINE_PROJECT_CONTEXT: |
    We are ElizaOS. Our mission is to develop an extensible, modular, open-source
    AI agent framework that thrives across both Web2 and Web3 ecosystems.

    Core Philosophy:
    - Autonomy & Adaptability: Agents should learn, reason, and adapt across diverse tasks.
    - Modularity & Composability: AI architectures should be modular for iterative improvements.
    - Decentralization & Open Collaboration: Moving beyond centralized control towards distributed intelligence.
  PIPELINE_REPOS: |
    [
      {"owner": "elizaos", "name": "eliza", "defaultBranch": "main"},
      {"owner": "elizaos", "name": "elizaos.github.io", "defaultBranch": "main"},
      {"owner": "elizaos", "name": "docs", "defaultBranch": "main"},
      {"owner": "elizaos", "name": "x402.elizaos.ai", "defaultBranch": "main"},
      {"owner": "elizaos", "name": "spartan", "defaultBranch": "main"},
      {"owner": "elizaos", "name": "jeju", "defaultBranch": "main"},
      {"owner": "elizaos-plugins", "name": "plugin-solana", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-knowledge", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-chart", "defaultBranch": "main"},
      {"owner": "elizaos-plugins", "name": "plugin-analytics", "defaultBranch": "main"},
      {"owner": "elizaos-plugins", "name": "plugin-jupiter", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-trust", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-rolodex", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-birdeye", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-digitaltwin", "defaultBranch": "main"},
      {"owner": "elizaos-plugins", "name": "plugin-mysql", "defaultBranch": "main"},
      {"owner": "elizaos-plugins", "name": "plugin-elizaos-cloud", "defaultBranch": "main"},
      {"owner": "elizaos-plugins", "name": "registry", "defaultBranch": "main"},
      {"owner": "elizaos-plugins", "name": "plugin-twitter", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-auton8n", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-evm", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-coingecko", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-farcaster", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-mcp", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-autocoder", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-discord", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-telegram", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-openrouter", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-openai", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-anthropic", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-relay", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-email", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-ollama", "defaultBranch": "1.x"},
      {"owner": "elizaos-plugins", "name": "plugin-pdf", "defaultBranch": "1.x"}
    ]
  PIPELINE_BOT_USERS: |
    ["dependabot", "dependabot-preview", "renovate", "renovate-bot", "renovate[bot]",
     "github-actions", "github-actions[bot]", "github-bot", "codecov", "codecov-io",
     "stale[bot]", "semantic-release-bot", "copilot-pull-request-reviewer", "imgbot",
     "coderabbitai", "codefactor-io", "graphite-app", "google-labs-jules[bot]", "cursor", "claude"]
  PIPELINE_SCORING: |
    {
      "pullRequest": {"base": 4, "merged": 16, "perReview": 1.5, "perApproval": 2, "perComment": 0.2, "descriptionMultiplier": 0.003, "complexityMultiplier": 0.5, "optimalSizeBonus": 5, "maxPerDay": 10, "closingIssueBonus": 5},
      "reaction": {"diminishingReturns": 0.7, "base": 0.5, "received": 0.1, "maxPerDay": 10, "types": {"thumbs_up": 1.2, "thumbs_down": 0.5, "laugh": 1.0, "hooray": 1.5, "confused": 0.5, "heart": 1.5, "rocket": 1.5, "eyes": 1.2}},
      "issue": {"base": 2, "perComment": 0.1, "withLabelsMultiplier": {"bug": 1.8, "enhancement": 1.4, "documentation": 1.0}, "closedBonus": 2, "resolutionSpeedMultiplier": 1.0},
      "review": {"base": 4, "approved": 1, "changesRequested": 2, "commented": 0.5, "detailedFeedbackMultiplier": 0.002, "thoroughnessMultiplier": 1.3, "maxPerDay": 8},
      "comment": {"base": 0.2, "substantiveMultiplier": 0.001, "diminishingReturns": 0.7, "maxPerThread": 3},
      "codeChange": {"perLineAddition": 0.005, "perLineDeletion": 0.01, "perFile": 0.15, "maxLines": 800, "testCoverageBonus": 2.0}
    }
  PIPELINE_TAGS: |
    {
      "area": [
        {"name": "core", "category": "AREA", "patterns": ["core/", "src/core", "packages/core"], "weight": 2.5, "description": "Core system components and libraries"},
        {"name": "ui", "category": "AREA", "patterns": ["components/", "ui/", "src/components", "pages/"], "weight": 1.8, "description": "User interface and component libraries"},
        {"name": "docs", "category": "AREA", "patterns": ["docs/", "README", ".md"], "weight": 1.5, "description": "Documentation and guides"},
        {"name": "infra", "category": "AREA", "patterns": [".github/", "docker", "k8s", ".yml", ".yaml"], "weight": 1.8, "description": "Infrastructure and deployment"},
        {"name": "tests", "category": "AREA", "patterns": ["test/", "tests/", ".spec.", ".test."], "weight": 2.0, "description": "Test files and test infrastructure"}
      ],
      "role": [
        {"name": "architect", "category": "ROLE", "patterns": ["feat:", "refactor:", "breaking:"], "weight": 2.5, "description": "Architects major features and refactorings"},
        {"name": "maintainer", "category": "ROLE", "patterns": ["fix:", "chore:", "bump:", "update:"], "weight": 2.0, "description": "Maintains codebase health and fixes issues"},
        {"name": "feature-dev", "category": "ROLE", "patterns": ["feat:", "feature:", "add:"], "weight": 2.0, "description": "Develops new features"},
        {"name": "bug-fixer", "category": "ROLE", "patterns": ["fix:", "bug:", "hotfix:"], "weight": 2.2, "description": "Identifies and fixes bugs"},
        {"name": "docs-writer", "category": "ROLE", "patterns": ["docs:", "documentation:"], "weight": 1.2, "description": "Writes and improves documentation"},
        {"name": "reviewer", "category": "ROLE", "patterns": ["review:", "feedback:"], "weight": 1.8, "description": "Reviews code and provides feedback"},
        {"name": "devops", "category": "ROLE", "patterns": ["ci:", "cd:", "deploy:", "build:"], "weight": 2.2, "description": "Works on CI/CD and deployment infrastructure"}
      ],
      "tech": [
        {"name": "typescript", "category": "TECH", "patterns": [".ts", ".tsx", "tsconfig"], "weight": 1.5, "description": "TypeScript language expertise"},
        {"name": "react", "category": "TECH", "patterns": ["react", ".jsx", ".tsx", "component"], "weight": 1.4, "description": "React framework expertise"},
        {"name": "nextjs", "category": "TECH", "patterns": ["next.", "nextjs", "pages/", "app/"], "weight": 1.6, "description": "Next.js framework expertise"},
        {"name": "tailwind", "category": "TECH", "patterns": ["tailwind", "tw-", "className"], "weight": 1.2, "description": "Tailwind CSS expertise"},
        {"name": "database", "category": "TECH", "patterns": ["sql", "db", "database", "query", "schema"], "weight": 1.7, "description": "Database and SQL expertise"},
        {"name": "api", "category": "TECH", "patterns": ["api", "rest", "graphql", "endpoint"], "weight": 1.6, "description": "API design and implementation"}
      ]
    }

jobs:
  build-and-deploy:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # Set up pipeline-data branch and restore data
      - name: Setup pipeline-data branch
        uses: ./.github/actions/pipeline-data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          operation: setup
          branch_name: ${{ env.PIPELINE_DATA_BRANCH }}
          data_dir: ${{ env.DATA_DIR }}

      # Restore database from dump
      - name: Restore database
        uses: ./.github/actions/restore-db
        with:
          operation: restore
          dump_dir: ${{ env.DATA_DIR }}/dump
          db_path: ${{ env.DATA_DIR }}/db.sqlite

      - name: Copy yesterday's stats for all tracked repositories
        run: |
          YESTERDAY=$(date -d "yesterday" +'%Y-%m-%d')
          shopt -s nullglob
          for file in data/*/stats/day/stats_${YESTERDAY}.json; do
            cp "$file" "${file%_*}.json"
            echo "Copied: $(basename $(dirname $(dirname $(dirname "$file"))))"
          done

      - name: Generate Directory Listings
        uses: jayanta525/github-pages-directory-listing@v4.0.0
        with:
          FOLDER: data

      # Auto-detect site URL based on repo type:
      # - Org/user sites (*.github.io): https://{owner}.github.io
      # - Project sites: https://{owner}.github.io/{repo}
      - name: Determine site URL
        id: site-config
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          OWNER="${{ github.repository_owner }}"
          if [[ "$REPO_NAME" == *.github.io ]]; then
            echo "site_url=https://${OWNER}.github.io" >> $GITHUB_OUTPUT
          else
            echo "site_url=https://${OWNER}.github.io/${REPO_NAME}" >> $GITHUB_OUTPUT
          fi

      - name: Build Next.js app
        run: bun run build
        env:
          NEXT_TELEMETRY_DISABLED: 1
          CI: true
          SITE_URL: ${{ secrets.SITE_URL || steps.site-config.outputs.site_url }}
          SITE_NAME: ${{ secrets.SITE_NAME || github.repository_owner }}
          NEXT_PUBLIC_SITE_NAME: ${{ secrets.SITE_NAME || github.repository_owner }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEXT_PUBLIC_GITHUB_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_GITHUB_CLIENT_ID }}
          NEXT_PUBLIC_AUTH_WORKER_URL: ${{ secrets.NEXT_PUBLIC_AUTH_WORKER_URL }}

      - name: Move data directory into out folder
        run: cp -r data out/

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: out

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # Cleanup worktree (always runs)
      - name: Cleanup
        if: always()
        uses: ./.github/actions/pipeline-data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          operation: cleanup
          branch_name: ${{ env.PIPELINE_DATA_BRANCH }}
          data_dir: ${{ env.DATA_DIR }}
